# ë‰´í„´ ë°©ë²•ìœ¼ë¡œ í•¨ìˆ˜ì˜ ìµœì†Œê°’ì„ ì°¾ì
import numpy as np
import matplotlib.pyplot as plt

f = lambda x: 0.1*x**3 - 0.8*x**2 - 1.5*x + 5.4 # ëª©ì í•¨ìˆ˜
fd = lambda x: 0.3*x**2 - 1.6*x - 1.5 # 1ì°¨ ë„í•¨ìˆ˜
fdd = lambda x: 0.6*x - 1.6 # 2ì°¨ ë„í•¨ìˆ˜

viz_range = np.array([-6, 12]) # í•¨ìˆ˜ ê·¸ë˜í”„ ë²”ìœ„
max_iter = 100 
min_tol = 1e-6 # ì¢…ë£Œì¡°ê±´
x_init = 12 # Try -2, 0, and 16/6 (a saddle point)

# ì‹œê°í™” ì¤€ë¹„
xs = np.linspace(*viz_range, 100) # viz_range ë²”ìœ„ì—ì„œ 100ê°œì˜ ì  ìƒì„±
plt.plot(xs, f(xs), 'r-', label='f(x)', linewidth=2)
plt.plot(x_init, f(x_init), 'b.', label='Each step', markersize=12)
plt.axis((*viz_range, *f(viz_range)))
plt.legend()

x = x_init
for i in range(max_iter):
    # ë‰´í„´ ë°©ë²• ì‹¤í–‰
    xp = x
    # ì•ˆì¥ì  ë° ê·¹ëŒ€ê°’ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì²˜ë¦¬
    if abs(fdd(x)) < 1e-6:  # fddê°€ 0ì— ê°€ê¹Œìš´ ê²½ìš°ë¥¼ ë°©ì§€
        print("fdd(x) is too small, stopping iteration to avoid division by zero")
        break
    x = x - fd(x) / (fdd(x) + 1e-6)  # ë¶„ëª¨ì— ì‘ì€ ê°’ì„ ë”í•˜ì—¬ 0ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ë°©ì§€
    
    # ê° ë°˜ë³µ ë‹¨ê³„ì˜ ê°’ ì¶œë ¥
    print(f'Iter: {i}, x = {xp:.3f} to {x:.3f}, f(x) = {f(xp):.3f} to {f(x):.3f} (f\'(x) = {fd(xp):.3f}, f\'\'(x) = {fdd(xp):.3f})')

    # ì‹œê°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    lcolor = np.random.rand(3)
    approx = 0.5*fdd(xp)*(xs-xp)**2 + fd(xp)*(xs-xp) + f(xp)
    plt.plot(xs, approx, '-', linewidth=1, color=lcolor, alpha=0.8)
    plt.plot(x, f(x), '.', color=lcolor, markersize=12)

    # ì¢…ë£Œ ì¡°ê±´ ì²´í¬
    if abs(x - xp) < min_tol:
        print(f"Converged at iteration {i}")
        break

# ìµœì¢… ê²°ê³¼ ì¶œë ¥
plt.show()



# Scipy ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•œ ìµœì í™” ë¬¸ì œ í’€ê¸°(ê·¹ì†Œê°’ ì°¾ê¸°)
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
import numpy as np               # ìˆ˜ì¹˜ ê³„ì‚°ì„ ìœ„í•œ NumPy ë¼ì´ë¸ŒëŸ¬ë¦¬
import matplotlib.pyplot as plt   # ê·¸ë˜í”„ ì‹œê°í™”ë¥¼ ìœ„í•œ Matplotlib ë¼ì´ë¸ŒëŸ¬ë¦¬
from scipy.optimize import minimize  # ìµœì í™” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ SciPyì˜ minimize í•¨ìˆ˜

# ëª©ì  í•¨ìˆ˜ ì •ì˜: f(x) = 0.1x^3 - 0.8x^2 - 1.5x + 5.4
f = lambda x: 0.1*x**3 - 0.8*x**2 - 1.5*x + 5.4 

# ê·¸ë˜í”„ ë²”ìœ„ë¥¼ ì„¤ì • (xì˜ ìµœì†Œê°’ê³¼ ìµœëŒ€ê°’)
viz_range = np.array([-6, 12]) 

# ìµœì í™” ê´€ë ¨ ë³€ìˆ˜ ì„¤ì •
max_iter = 100            # ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜
min_tol = 1e-6           # ìˆ˜ë ´ ì¡°ê±´: ë‘ ê°’ì˜ ì°¨ì´ê°€ ì´ ê°’ë³´ë‹¤ ì‘ì•„ì§€ë©´ ì¢…ë£Œ
x_init = 12               # ì´ˆê¸°ê°’ ì„¤ì • (ì—¬ê¸°ì„œëŠ” 12ë¡œ ì‹œì‘)

# SciPyë¥¼ ì´ìš©í•˜ì—¬ ìµœì†Œê°’ ì°¾ê¸°
result = minimize(f, x_init, tol=min_tol, options={'maxiter': max_iter, 'return_all': True})

# ìµœì í™” ê²°ê³¼ ì¶œë ¥
print(result)  # ê²°ê³¼ì—ëŠ” ê·¹ì†Œê°’, ë°˜ë³µ íšŸìˆ˜, ì„±ê³µ ì—¬ë¶€ ë“±ì´ í¬í•¨ë¨

# ê·¸ë˜í”„ë¥¼ ê·¸ë¦¬ê¸° ìœ„í•œ xê°’ ìƒì„±
xs = np.linspace(*viz_range, 100)  # ì§€ì •í•œ ë²”ìœ„ì—ì„œ 100ê°œì˜ ì  ìƒì„±
plt.plot(xs, f(xs), 'r-', label='f(x)', linewidth=2)  # í•¨ìˆ˜ f(x)ì˜ ê·¸ë˜í”„ë¥¼ ë¹¨ê°„ ì„ ìœ¼ë¡œ ê·¸ë¦¬ê¸°

# ëª¨ë“  ë°˜ë³µ ê³¼ì •ì—ì„œì˜ xê°’ì„ ìˆ˜ì§ ë°°ì—´ë¡œ ë³€í™˜
xr = np.vstack(result.allvecs)  
plt.plot(xr, f(xr), 'b.', label='Each step', markersize=12)  # ê° ë‹¨ê³„ì—ì„œì˜ f(x) ê°’ì„ íŒŒë€ ì ìœ¼ë¡œ í‘œì‹œ

# ê·¸ë˜í”„ì˜ ë²”ë¡€ì™€ ì¶• ë²”ìœ„ ì„¤ì •
plt.legend()  # ë²”ë¡€ ì¶”ê°€
plt.axis((*viz_range, *f(viz_range)))  # xì¶•ê³¼ yì¶•ì˜ ë²”ìœ„ ì„¤ì •
plt.show()  # ê·¸ë˜í”„ë¥¼ í™”ë©´ì— í‘œì‹œ

# ì„ í˜•íšŒê·€ë¥¼ í†µí•œ ìµœì í™” ë¬¸ì œ
# ì§„ì§œ ì§ì„ ì„ ì •ì˜í•˜ëŠ” í•¨ìˆ˜: y = -14/3*x + 14/3
true_line = lambda x: -14/3*x + 14/3

# ë°ì´í„°ì˜ ë²”ìœ„ ì„¤ì •
data_range = np.array([-4, 12])  # x ê°’ì˜ ë²”ìœ„ë¥¼ -4ì—ì„œ 12ê¹Œì§€ ì„¤ì •
data_num = 100                     # ìƒì„±í•  ë°ì´í„° í¬ì¸íŠ¸ì˜ ìˆ˜
noise_std = 1                      # ê°€ìš°ì‹œì•ˆ ë…¸ì´ì¦ˆì˜ í‘œì¤€í¸ì°¨

# ì§„ì§œ ë°ì´í„° ìƒì„±
# data_range ë‚´ì—ì„œ ê· ë“±í•˜ê²Œ ë¶„í¬ëœ x ê°’ 100ê°œë¥¼ ìƒì„±
x = np.random.uniform(data_range[0], data_range[1], size=data_num)
# ì§„ì§œ y ê°’ ìƒì„±
y = true_line(x)

# ê°€ìš°ì‹œì•ˆ ë…¸ì´ì¦ˆ ì¶”ê°€
# x ê°’ì— ë…¸ì´ì¦ˆë¥¼ ì¶”ê°€í•˜ì—¬ xn ìƒì„±
xn = x + np.random.normal(scale=noise_std, size=x.shape)
# y ê°’ì—ë„ ë…¸ì´ì¦ˆë¥¼ ì¶”ê°€í•˜ì—¬ yn ìƒì„±
yn = y + np.random.normal(scale=noise_std, size=y.shape)

# ëŒ€ìˆ˜ì  ê±°ë¦¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ì§ì„  ì°¾ê¸°
# xnê³¼ 1ë¡œ ì´ë£¨ì–´ì§„ í–‰ë ¬ Aë¥¼ ìˆ˜ì§ ìŠ¤íƒí•˜ì—¬ í–‰ë ¬ Aë¥¼ ìƒì„±
A = np.vstack((xn, np.ones(xn.shape))).T
b = yn  # y ê°’ì€ bë¡œ ì„¤ì •
# í”¼íŒ…ëœ ì§ì„ ì˜ ê³„ìˆ˜ë¥¼ ê³„ì‚°: Aì˜ ë¬´ì–´-íœë¡œì¦ˆ ìœ ì‚¬ ì—­í–‰ë ¬ì„ ì‚¬ìš©
l_alg = np.linalg.pinv(A) @ b
# í”¼íŒ…ëœ ì§ì„ ì˜ í‰ê·  ì ˆëŒ€ ì˜¤ì°¨ ê³„ì‚°
e_alg = np.mean(np.abs(l_alg[0]*xn - yn + l_alg[1]) / np.sqrt(l_alg[0]**2 + 1))

# ê¸°í•˜í•™ì  ê±°ë¦¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ì§ì„  ì°¾ê¸°
# ê¸°í•˜í•™ì  ê±°ë¦¬ í•¨ìˆ˜ ì •ì˜
geo_dist2 = lambda x: np.sum((x[0]*xn - yn + x[1])**2) / (x[0]**2 + 1)
# ê¸°í•˜í•™ì  ê±°ë¦¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ê²°ê³¼ë¥¼ ì°¾ê¸° ìœ„í•´ minimize í•¨ìˆ˜ í˜¸ì¶œ
result = minimize(geo_dist2, [-1, 0])  # ì´ˆê¸°ê°’ ì„¤ì •: y = -xë¡œ ì‹œì‘
l_geo = result.x  # ìµœì í™” ê²°ê³¼ì—ì„œ ì§ì„ ì˜ ê³„ìˆ˜ ì¶”ì¶œ
# ê¸°í•˜í•™ì  ê±°ë¦¬ì˜ í‰ê·  ì ˆëŒ€ ì˜¤ì°¨ ê³„ì‚°
e_geo = np.mean(np.abs(l_geo[0]*xn - yn + l_geo[1]) / np.sqrt(l_geo[0]**2 + 1))

# ë°ì´í„° ë° ê²°ê³¼ë¥¼ ì‹œê°í™”
plt.plot(data_range, true_line(data_range), 'r-', label='The true line')  # ì§„ì§œ ì§ì„ 
plt.plot(xn, yn, 'b.', label='Noisy data')  # ë…¸ì´ì¦ˆê°€ ì¶”ê°€ëœ ë°ì´í„° í¬ì¸íŠ¸
plt.plot(data_range, l_alg[0]*data_range + l_alg[1], 'g-', label=f'Solve Ax=b (GeoError: {e_alg:.3f})')  # ëŒ€ìˆ˜ì  ê±°ë¦¬ í”¼íŒ… ê²°ê³¼
plt.plot(data_range, l_geo[0]*data_range + l_geo[1], 'm-', label=f'Optimization (GeoError: {e_geo:.3f})')  # ê¸°í•˜í•™ì  ê±°ë¦¬ í”¼íŒ… ê²°ê³¼
plt.legend()  # ë²”ë¡€ ì¶”ê°€
plt.xlim(data_range)  # xì¶•ì˜ ë²”ìœ„ ì„¤ì •
plt.show()  # ê·¸ë˜í”„ë¥¼ í™”ë©´ì— í‘œì‹œ


# ì´ ì½”ë“œëŠ” ë…¸ì´ì¦ˆê°€ í¬í•¨ëœ ë°ì´í„°ì— ëŒ€í•œ ì„ í˜• íšŒê·€ë¥¼ í†µí•´ ìµœì ì˜ ì§ì„ ì„ ì°¾ëŠ” ê³¼ì •ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë‹¤ìŒì€ ì´ ì½”ë“œê°€ ëª©í‘œë¡œ í•˜ëŠ” ë°”ë¥¼ ìš”ì•½í•œ ë‚´ìš©ì…ë‹ˆë‹¤:

# ì½”ë“œì˜ ëª©ì  ë° ì„¤ëª…
# ì§„ì§œ ì§ì„  ì •ì˜:

# ì§„ì§œ ë°ì´í„°ëŠ” ì„ í˜• ê´€ê³„ë¥¼ ê°–ê³  ìˆìœ¼ë©°, ì´ ì½”ë“œì—ì„œëŠ” true_line í•¨ìˆ˜ë¥¼ í†µí•´ ì •ì˜ëœ ì§„ì§œ ì§ì„ ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì§ì„ ì€ ë°ì´í„°ì˜ ì‹¤ì œ ê´€ê³„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
# ë…¸ì´ì¦ˆê°€ í¬í•¨ëœ ë°ì´í„° ìƒì„±:

# ì§„ì§œ ì§ì„  ìœ„ì˜ 
# ğ‘¦
# y ê°’ì— ê°€ìš°ì‹œì•ˆ ë…¸ì´ì¦ˆë¥¼ ì¶”ê°€í•˜ì—¬ ë…¸ì´ì¦ˆê°€ í¬í•¨ëœ ë°ì´í„° í¬ì¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ëŠ” í˜„ì‹¤ ì„¸ê³„ì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°ê°€ í•­ìƒ ì™„ë²½í•˜ì§€ ì•ŠìŒì„ ë°˜ì˜í•©ë‹ˆë‹¤.
# ë‘ ê°€ì§€ í”¼íŒ… ë°©ë²•:

# ëŒ€ìˆ˜ì  ê±°ë¦¬ ìµœì†Œí™”: ë°ì´í„° ì ë“¤ê³¼ ì§ì„  ì‚¬ì´ì˜ ìˆ˜ì§ ê±°ë¦¬ì˜ í•©ì„ ìµœì†Œí™”í•˜ëŠ” ì§ì„ ì„ ì°¾ìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì€ ê° ë°ì´í„° í¬ì¸íŠ¸ì™€ í”¼íŒ…ëœ ì§ì„  ì‚¬ì´ì˜ ìˆ˜ì§ ê±°ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìµœì í™”í•©ë‹ˆë‹¤.
# ê¸°í•˜í•™ì  ê±°ë¦¬ ìµœì†Œí™”: ë°ì´í„° ì ë“¤ê³¼ ì§ì„  ì‚¬ì´ì˜ ì‹¤ì œ ê±°ë¦¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ì§ì„ ì„ ì°¾ìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì€ ê±°ë¦¬ì˜ ì œê³±ì„ í•©ì‚°í•˜ì—¬ ìµœì ì˜ ì§ì„ ì„ ë„ì¶œí•©ë‹ˆë‹¤.
# ê²°ê³¼ ì‹œê°í™”:

# ìµœì¢…ì ìœ¼ë¡œ, ê·¸ë˜í”„ë¥¼ í†µí•´ ì§„ì§œ ì§ì„ , ë…¸ì´ì¦ˆê°€ í¬í•¨ëœ ë°ì´í„° ì ë“¤, ê·¸ë¦¬ê³  ë‘ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì°¾ì€ ìµœì ì˜ ì§ì„ ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê° ë°©ë²•ì´ ì–´ë–»ê²Œ ë°ì´í„°ì— ì í•©í•˜ê²Œ ì§ì„ ì„ ì°¾ëŠ”ì§€ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
